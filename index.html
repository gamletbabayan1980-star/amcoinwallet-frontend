<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Amcoin Wallet ‚Äî Mainnet</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/bip39@3.0.4/browser/bip39.min.js"></script>
  <script src="https://unpkg.com/tonweb@0.0.63/dist/tonweb.js"></script>
  <style>
    :root { --bg:#f7f8fa; --text:#111827; }
    [data-theme='dark'] { --bg:#0d1117; --text:#f6f8fa; }
    html,body,#root { height:100%; margin:0; }
    body { background:var(--bg); color:var(--text); font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }
    .container { max-width:900px; margin:0 auto; padding:20px; }
    .box { background:white; border-radius:12px; padding:16px; margin-bottom:16px; box-shadow:0 6px 18px rgba(0,0,0,0.04); }
    [data-theme='dark'] .box { background:#071025; box-shadow:none; }
    button { cursor:pointer; padding:8px 12px; border-radius:8px; border:none; background:#4F46E5; color:white; }
    button:hover { opacity:0.9; }
    textarea,input { width:100%; padding:8px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px; }
    code { font-family:monospace; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">

    const { useState, useEffect, useRef } = React;

    const TONCENTER_URL = "https://toncenter.com/api/v2";
    const TONCENTER_API_KEY = "";
    const AMCOIN_MASTER = "EQAfysdj5lEz7LfEjybqSe-TFLdC1bMEW5zOvACn2xCjcIKV";
    const STORAGE_KEY = "amcoin:encSeed";

    const arrayBufferToHex = (buffer) =>
      Array.from(new Uint8Array(buffer)).map(b=>b.toString(16).padStart(2,"0")).join("");
    const hexToArrayBuffer = (hex) => {
      if (!hex) return new Uint8Array([]);
      const bytes = new Uint8Array(hex.length/2);
      for (let i=0;i<bytes.length;i++) bytes[i]=parseInt(hex.substr(i*2,2),16);
      return bytes;
    };

    function App() {
      const [theme,setTheme]=useState(localStorage.getItem("amcoin:theme")||"light");
      const [mnemonic,setMnemonic]=useState("");
      const [password,setPassword]=useState("");
      const [address,setAddress]=useState("‚Äî");
      const [tonBalance,setTonBalance]=useState("‚Äî");
      const [amcoinBalance,setAmcoinBalance]=useState("‚Äî");
      const [log,setLog]=useState([]);
      const logRef=useRef(null);
      const [isLoading,setIsLoading]=useState(false);

      useEffect(()=>{document.documentElement.setAttribute("data-theme",theme);localStorage.setItem("amcoin:theme",theme);},[theme]);
      useEffect(()=>{if(logRef.current)logRef.current.scrollTop=logRef.current.scrollHeight;},[log]);
      const pushLog=(...parts)=>setLog(prev=>[...prev,`[${new Date().toLocaleTimeString()}] ${parts.join(" ")}`].slice(-300));

      async function handleGenerateMnemonic(){
        try{const m=bip39.generateMnemonic();setMnemonic(m);pushLog("mnemonic —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω");}catch(e){pushLog("–û—à–∏–±–∫–∞:",e.message);}
      }
      async function saveEncryptedSeed(){
        if(!mnemonic||!password){pushLog("mnemonic –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã");return;}
        try{
          const enc=new TextEncoder();
          const salt=crypto.getRandomValues(new Uint8Array(16));
          const iv=crypto.getRandomValues(new Uint8Array(12));
          const baseKey=await crypto.subtle.importKey("raw",enc.encode(password),{name:"PBKDF2"},false,["deriveKey"]);
          const key=await crypto.subtle.deriveKey({name:"PBKDF2",salt,iterations:200000,hash:"SHA-256"},baseKey,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
          const ciphertext=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,enc.encode(mnemonic));
          localStorage.setItem(STORAGE_KEY,JSON.stringify({salt:arrayBufferToHex(salt),iv:arrayBufferToHex(iv),data:arrayBufferToHex(ciphertext)}));
          pushLog("mnemonic –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
        }catch(e){pushLog("–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:",e.message);}
      }
      async function loadEncryptedSeed(){
        try{
          const raw=localStorage.getItem(STORAGE_KEY);
          if(!raw){pushLog("Seed –Ω–µ –Ω–∞–π–¥–µ–Ω");return;}
          const encObj=JSON.parse(raw);
          const enc=new TextEncoder();
          const salt=hexToArrayBuffer(encObj.salt), iv=hexToArrayBuffer(encObj.iv), data=hexToArrayBuffer(encObj.data);
          const baseKey=await crypto.subtle.importKey("raw",enc.encode(password),{name:"PBKDF2"},false,["deriveKey"]);
          const key=await crypto.subtle.deriveKey({name:"PBKDF2",salt,iterations:200000,hash:"SHA-256"},baseKey,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
          const plain=await crypto.subtle.decrypt({name:"AES-GCM",iv},key,data);
          setMnemonic(new TextDecoder().decode(plain));
          pushLog("mnemonic —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω");
        }catch(e){pushLog("–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏:",e.message);}
      }

      async function deriveAddress(){
        if(!mnemonic){pushLog("–ù–µ—Ç mnemonic");return;}
        setIsLoading(true);
        try{
          const seed=await bip39.mnemonicToSeed(mnemonic);
          const tonweb=new TonWeb(new TonWeb.HttpProvider(`${TONCENTER_URL}/jsonRPC`));
          const keyPair=TonWeb.utils.keyPairFromSeed(seed.slice(0,32));
          const wallet=new tonweb.wallet.all.v3R2(tonweb.provider,{publicKey:keyPair.publicKey});
          const addr=await wallet.getAddress();
          const addrStr=addr.toString(true,true,true);
          setAddress(addrStr);
          pushLog("–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–µ–Ω:",addrStr);
        }catch(e){pushLog("–û—à–∏–±–∫–∞:",e.message);}finally{setIsLoading(false);}
      }

      async function fetchTonBalance(addr){
        try{
          const url=`${TONCENTER_URL}/getAddressInformation?address=${encodeURIComponent(addr)}${TONCENTER_API_KEY?`&api_key=${TONCENTER_API_KEY}`:""}`;
          const res=await fetch(url);const j=await res.json();
          return j.ok&&j.result?j.result.balance||0:0;
        }catch(e){pushLog("–û—à–∏–±–∫–∞ TON –±–∞–ª–∞–Ω—Å–∞:",e.message);return 0;}
      }

      async function fetchAmcoinBalance(addr){
        try{
          const tonweb=new TonWeb(new TonWeb.HttpProvider(`${TONCENTER_URL}/jsonRPC`));
          const jettonWalletAddr=await tonweb.jetton.getWalletAddress(AMCOIN_MASTER,addr);
          pushLog("AMCOIN wallet addr:",jettonWalletAddr.toString());
          const url=`${TONCENTER_URL}/getAddressInformation?address=${encodeURIComponent(jettonWalletAddr.toString())}${TONCENTER_API_KEY?`&api_key=${TONCENTER_API_KEY}`:""}`;
          const res=await fetch(url);const j=await res.json();
          return j.ok&&j.result?j.result.balance||0:0;
        }catch(e){pushLog("–û—à–∏–±–∫–∞ AMCOIN:",e.message);return 0;}
      }

      async function handleCheckBalances(){
        if(address==="‚Äî"){pushLog("–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å");return;}
        setIsLoading(true);setTonBalance("...");setAmcoinBalance("...");
        try{
          const t=await fetchTonBalance(address);
          setTonBalance(`${t} nanoTON`);
          const a=await fetchAmcoinBalance(address);
          setAmcoinBalance(a);
          pushLog("–ë–∞–ª–∞–Ω—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã");
        }catch(e){pushLog("–û—à–∏–±–∫–∞ –±–∞–ª–∞–Ω—Å–æ–≤:",e.message);}finally{setIsLoading(false);}
      }

      return (
        <div className="container">
          <h1>üíé Amcoin Wallet ‚Äî Mainnet</h1>

          <div className="box">
            <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div>TonCenter: mainnet ({TONCENTER_API_KEY?"API key set":"no API key"})</div>
            <button onClick={()=>setTheme(t=>t==="light"?"dark":"light")}>–¢–µ–º–∞: {theme==="light"?"üåû –°–≤–µ—Ç–ª–∞—è":"üåô –¢—ë–º–Ω–∞—è"}</button>
          </div>

          <div className="box">
            <h3>üîë Seed / –ö–ª—é—á–∏</h3>
            <button onClick={handleGenerateMnemonic}>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å mnemonic</button>
            <button onClick={saveEncryptedSeed}>–ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onClick={loadEncryptedSeed}>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π</button>
            <textarea rows={2} value={mnemonic} onChange={e=>setMnemonic(e.target.value)} placeholder="mnemonic" />
            <input type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="–ü–∞—Ä–æ–ª—å" />
            <button onClick={deriveAddress}>–ü–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å</button>
          </div>

          <div className="box">
            <h3>üìä –ê–∫–∫–∞—É–Ω—Ç</h3>
            <div>Address: <code style={{wordBreak:"break-all"}}>{address}</code></div>
            <div style={{display:"flex",gap:8,marginTop:8}}>
              <div style={{flex:1,padding:12,borderRadius:8,background:"#f3f4f6"}}>TON: <strong>{tonBalance}</strong></div>
              <div style={{flex:1,padding:12,borderRadius:8,background:"#f3f4f6"}}>AMCOIN: <strong>{amcoinBalance}</strong></div>
            </div>
            <button style={{marginTop:12}} onClick={handleCheckBalances}>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã</button>
          </div>

          <div className="box">
            <h3>üìã –õ–æ–≥–∏</h3>
            <div ref={logRef} style={{maxHeight:200,overflow:"auto",padding:12,background:"#fff",borderRadius:8}}>
              {log.length===0?<div style={{color:"#777"}}>–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</div>:log.map((l,i)=><div key={i}>{l}</div>)}
            </div>
          </div>
        </div>
      );
    }

    const root=ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App/>);

  </script>
</body>
</html>
