<!doctype html>
<!--
  Amcoin Wallet — single-file scaffold
  License: This scaffold inherits obligations from any upstream GPL code you used.
  This file is a template. DO NOT use in production without security audit.
  Replace placeholders: AMCOIN_MASTER_ADDRESS, RPC_ENDPOINT, etc.
-->
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Amcoin Wallet (Demo)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; max-width:900px; margin:20px auto; padding:10px; }
    h1 { font-size:22px; }
    .box { border:1px solid #ddd; padding:12px; border-radius:8px; margin-bottom:12px; }
    input, textarea, button, select { font-size:14px; padding:8px; margin:4px 0; width:100%; box-sizing:border-box; }
    .row { display:flex; gap:8px; }
    .col { flex:1; }
    .small { font-size:13px; color:#555; }
    .danger { color:#a00; font-weight:600; }
    code { background:#f4f4f4; padding:2px 6px; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Amcoin Wallet — демо (single-file)</h1>
  <p class="small">Шаблон для работы с токеном <strong>Amcoin</strong>. Замените <code>AMCOIN_MASTER_ADDRESS</code> и <code>RPC_ENDPOINT</code> в секции <em>Настройки</em>.</p>

  <div class="box">
    <h2>Настройки (обязательно изменить)</h2>
    <p class="small">Задайте RPC (TON API) и мастер-адрес/контракт Amcoin (TIP-3 / другой стандарт). Пока что используются заглушки.</p>
    <label>RPC endpoint (TON RPC / TONCENTER / TON API):</label>
    <input id="rpcEndpoint" value="https://toncenter.com/api/v2/jsonRPC" />
    <label>Master / Root адрес токена Amcoin (контракт):</label>
    <input id="amcoinMaster" value="AMCOIN_MASTER_ADDRESS" />
    <label>Network (mainnet/testnet):</label>
    <select id="network">
      <option value="mainnet">mainnet</option>
      <option value="testnet">testnet</option>
    </select>
  </div>

  <div class="box">
    <h2>Seed / Кошелёк</h2>
    <div class="row">
      <div class="col">
        <button id="genSeedBtn">Сгенерировать новый seed (mnemonic)</button>
        <button id="clearSeedBtn">Очистить</button>
      </div>
    </div>
    <label>Mnemonic (seed phrase):</label>
    <textarea id="mnemonic" rows="2" placeholder="12/24 words"></textarea>
    <label>Пароль (опционально):</label>
    <input id="mnemonicPass" placeholder="опционально" />

    <div style="margin-top:8px;">
      <button id="deriveBtn">Восстановить / Получить адрес</button>
    </div>

    <p class="small">Seed храните только локально. Никому не передавайте.</p>
  </div>

  <div class="box">
    <h2>Информация об адресе</h2>
    <p>Public key (hex): <code id="pubkey">—</code></p>
    <p>TON address: <code id="tonAddress">—</code></p>
    <p> TON balance (native): <code id="tonBal">—</code> <span class="small">(примерно)</span></p>
    <p> Amcoin balance: <code id="tokenBal">—</code></p>
    <div style="margin-top:6px;">
      <button id="refreshBtn">Обновить балансы</button>
    </div>
  </div>

  <div class="box">
    <h2>Отправка Amcoin</h2>
    <label>Кому (TON address):</label>
    <input id="toAddress" placeholder="EQ... или 0:..." />
    <label>Количество Amcoin:</label>
    <input id="amount" placeholder="Например 10" />
    <label>Комментарий (опционально):</label>
    <input id="comment" placeholder="memo" />
    <div style="margin-top:8px;">
      <button id="sendBtn">Отправить Amcoin</button>
    </div>
    <p id="txResult" class="small"></p>
  </div>

  <div class="box">
    <h2>Логи / предупреждения</h2>
    <div id="log" style="white-space:pre-wrap; max-height:240px; overflow:auto; background:#fafafa; padding:8px;"></div>
  </div>

  <!-- External libs (CDN). Если одно из подключений не работает, замените на локальные сборки. -->
  <script src="https://unpkg.com/bip39@3.0.4/browser.js"></script>
  <script src="https://unpkg.com/tweetnacl@1.0.3/nacl.min.js"></script>
  <!-- TonWeb: если CDN изменится, нужно поставить актуальную ссылку/локальную сборку -->
  <script src="https://unpkg.com/tonweb/dist/tonweb.min.js"></script>

  <script>
    /****************************************************************
     * Amcoin Wallet — single-file demo
     * Важно:
     *  - Этот файл — шаблон. Перед использованием замените все заглушки.
     *  - Проверьте совместимость версий библиотек (bip39, tonweb).
     *  - Проведите security / code audit перед использованием с реальными средствами.
     ****************************************************************/

    // ---------- УТИЛИТЫ ----------
    const logEl = document.getElementById('log');
    function log(...args){ const t = new Date().toLocaleString(); logEl.textContent += `[${t}] ` + args.join(' ') + "\n"; logEl.scrollTop = logEl.scrollHeight; }
    function err(msg){ log("ERROR:", msg); console.error(msg); }

    // ---------- ПОДСТАВЬ ЗДЕСЬ СВОИ ДАННЫЕ (или оставь для интерактивной настройки) ----------
    const DEFAULT_RPC = document.getElementById('rpcEndpoint').value; // поменяется при клике
    const PLACEHOLDER_MASTER = document.getElementById('amcoinMaster').value;

    // ---------- DOM ----------
    const genSeedBtn = document.getElementById('genSeedBtn');
    const clearSeedBtn = document.getElementById('clearSeedBtn');
    const deriveBtn = document.getElementById('deriveBtn');
    const mnemonicEl = document.getElementById('mnemonic');
    const passEl = document.getElementById('mnemonicPass');
    const pubkeyEl = document.getElementById('pubkey');
    const tonAddressEl = document.getElementById('tonAddress');
    const tonBalEl = document.getElementById('tonBal');
    const tokenBalEl = document.getElementById('tokenBal');
    const refreshBtn = document.getElementById('refreshBtn');
    const sendBtn = document.getElementById('sendBtn');
    const toAddressEl = document.getElementById('toAddress');
    const amountEl = document.getElementById('amount');
    const commentEl = document.getElementById('comment');
    const pubState = { publicKeyHex: null, secretKey: null, addressRaw: null };

    // ---------- Генерация / восстановление seed ----------
    genSeedBtn.addEventListener('click', () => {
      const mnemonic = bip39.generateMnemonic(128); // 12 words
      mnemonicEl.value = mnemonic;
      log("Сгенерирован новый mnemonic (12 слов).");
    });

    clearSeedBtn.addEventListener('click', () => {
      mnemonicEl.value = '';
      passEl.value = '';
      pubkeyEl.textContent = '—'; tonAddressEl.textContent = '—'; tonBalEl.textContent='—'; tokenBalEl.textContent='—';
      pubState.publicKeyHex = null; pubState.secretKey = null; pubState.addressRaw = null;
      log("Очищено.");
    });

    // ---------- ВОССТАНОВЛЕНИЕ ключей (mnemonic -> ed25519 keypair) ----------
    // Замечание: здесь используется стандартная схема: mnemonic -> seed (bip39) -> seed32 -> ed25519 keypair (tweetnacl).
    // Для TON принято использовать ed25519. Для некоторых реализаций нужны дополнительные шаги (derivation path и т.д.).
    deriveBtn.addEventListener('click', async () => {
      try {
        const mnemonic = mnemonicEl.value.trim();
        if(!mnemonic){ err("mnemonic пустой"); return; }
        // Получаем seed (Buffer)
        const pass = passEl.value || '';
        const seedBuffer = bip39.mnemonicToSeedSync(mnemonic, pass); // Buffer
        // Для ed25519 нам нужен 32-байт seed
        const seed32 = seedBuffer.slice(0,32);
        // tweetnacl expects Uint8Array
        const keyPair = nacl.sign.keyPair.fromSeed(new Uint8Array(seed32));
        const pubkey = Buffer.from(keyPair.publicKey).toString('hex');
        const secret = Buffer.from(keyPair.secretKey).toString('hex'); // содержит и секрет и публичную часть в одном буфере (64 байта)
        pubState.publicKeyHex = pubkey;
        pubState.secretKey = keyPair.secretKey; // Uint8Array(64)
        pubkeyEl.textContent = pubkey;
        log("Ключи получены из mnemonic (ed25519).");

        // Теперь получим TON-адрес из публичного ключа — используем TonWeb
        if(typeof TonWeb === 'undefined'){
          err("TonWeb не найден. Проверьте подключение tonweb (CDN). Адрес не рассчитан автоматически.");
          tonAddressEl.textContent = '—';
          return;
        }

        // TonWeb ожидает hex-представление публичного ключа без '0x'
        const tonweb = new TonWeb(new TonWeb.HttpProvider(document.getElementById('rpcEndpoint').value || DEFAULT_RPC));
        // В TON адрес может быть получен через Wallet contract, но simplest: создать Wallet contract from public key (например Wallet v3)
        // Ниже пример создания адреса для Wallet v3 (public key to address).
        // ВАЖНО: реальная форма зависит от используемого кошелька (wallet contract). Здесь используем стандартный Wallet V3R2 (при наличии TonWeb.wallet.all).
        try {
          const WalletContract = TonWeb.wallet.all['v3R2']; // может отличаться в зависимости от версии TonWeb
          if(!WalletContract){
            log("Wallet contract v3R2 не обнаружен в TonWeb. Попробуйте другую версию или вручную укажите контракт.");
            tonAddressEl.textContent = '—';
          } else {
            const walletContract = new WalletContract({ publicKey: '0x' + pubkey });
            const address = await walletContract.getAddress().toString(true, true, true);
            tonAddressEl.textContent = address;
            pubState.addressRaw = address;
            log("TON address рассчитан (через Wallet v3R2).");
          }
        } catch(e){
          err("Ошибка при получении адреса: " + e);
          tonAddressEl.textContent = '—';
        }
      } catch(e){
        err("Ошибка восстановления: " + e);
      }
    });

    // ---------- Балансы (native + Amcoin) ----------
    // Здесь реализован пример запросов к RPC (toncenter/т.п.) — это упрощённо и зависит от выбранного API.
    async function fetchTonBalance(rpc, address){
      if(!address) return null;
      // Пример для TonCenter JSON-RPC: method getAddressInformation / getAddressInfo differs by provider.
      // Универсальный способ: использовать TonWeb provider (tonweb.provider).
      try {
        if(typeof TonWeb !== 'undefined'){
          const tonweb = new TonWeb(new TonWeb.HttpProvider(rpc));
          const provider = tonweb.provider;
          const balanceNano = await provider.getBalance(address); // может возвращать BigNumber или строку
          // provider.getBalance иногда возвращает BN-like; попробуем привести:
          const bal = balanceNano ? balanceNano.toString() : '0';
          return bal; // баланс в нанотоннах (1 TON = 10^9 nanotons?), уточнить в SDK
        } else {
          // Если TonWeb не доступен — попытка вызвать RPC напрямую (JSON-RPC)
          const body = {
            jsonrpc: "2.0",
            id: 1,
            method: "runGetMethod",
            params: [address, "get_wallet_data", []] // пример, НУЖНО адаптировать
          };
          // NOTE: большинство публичных RPC не позволяют runGetMethod без контракта/ton_vm
          return null;
        }
      } catch(e){
        err("fetchTonBalance error: " + e);
        return null;
      }
    }

    // Получение баланса Amcoin — пример для TIP-3: нужно вызвать метод смарт-контракта токена getWalletData или getBalance
    async function fetchAmcoinBalance(rpc, ownerAddress, amcoinRootAddress){
      try {
        if(!amcoinRootAddress || amcoinRootAddress === 'AMCOIN_MASTER_ADDRESS') {
          log("Amcoin master address не задан — баланс не получен.");
          return null;
        }
        if(typeof TonWeb === 'undefined'){
          err("TonWeb не подключён — невозможно прочитать контракт токена автоматически.");
          return null;
        }
        const tonweb = new TonWeb(new TonWeb.HttpProvider(rpc));
        // Для TIP-3 нужно:
        // 1) получить токен-кошелёк (jetton wallet) адрес для данного ownerAddress / root (root.getWalletAddress(owner))
        // 2) вызвать getBalance на jetton wallet
        const JettonMaster = new tonweb.token.jetton.JettonMaster({ address: amcoinRootAddress, provider: tonweb.provider });
        // Но TonWeb API может отличаться — ниже общий подход с try/catch:
        try {
          const walletAddress = await JettonMaster.getWalletAddress(ownerAddress); // возможно возвращает Address object
          const bal = await tonweb.provider.callGetMethod(walletAddress.toString(true, true, true), 'get_balance'); // пример
          // Преобразование результата зависит от возвращаемого формата
          return bal ? JSON.stringify(bal) : null;
        } catch(e){
          // если JettonMaster API не совпадает -> попробуем runGetMethod на root/jetton-wallet
          log("Не удалось через JettonMaster: " + e);
          return null;
        }
      } catch(e){
        err("fetchAmcoinBalance error: " + e);
        return null;
      }
    }

    refreshBtn.addEventListener('click', async () => {
      const rpc = document.getElementById('rpcEndpoint').value;
      const amroot = document.getElementById('amcoinMaster').value;
      const addr = pubState.addressRaw || tonAddressEl.textContent;
      if(!addr || addr === '—'){ err("Адрес кошелька не задан."); return; }
      log("Запрос балансов для", addr);
      tonBalEl.textContent = '...';
      tokenBalEl.textContent = '...';
      const tonBal = await fetchTonBalance(rpc, addr);
      tonBalEl.textContent = tonBal || '—';
      const tokBal = await fetchAmcoinBalance(rpc, addr, amroot);
      tokenBalEl.textContent = tokBal || '—';
      log("Балансы обновлены.");
    });

    // ---------- ОТПРАВКА Amcoin ----------
    // Простейший flow (TIP-3): формируем transfer транзакцию к jetton wallet контракта токена.
    // Реальная реализация требует:
    //  - получить Jetton Wallet адрес отправителя (root.getWalletAddress)
    //  - сформировать internal transfer с payload (специфика TIP-3)
    //  - подписать транзакцию приватным ключом (wallet contract)
    //  - отправить через provider.sendRawTransaction или используя TonWeb Wallet methods
    sendBtn.addEventListener('click', async () => {
      const rpc = document.getElementById('rpcEndpoint').value;
      const amroot = document.getElementById('amcoinMaster').value;
      const to = toAddressEl.value.trim();
      const amount = amountEl.value.trim();
      const memo = commentEl.value.trim();
      if(!pubState.secretKey){ err("Сначала восстановите кошелёк (derive)."); return; }
      if(!amroot || amroot === 'AMCOIN_MASTER_ADDRESS'){ err("Укажите AMCOIN_MASTER_ADDRESS в настройках."); return; }
      if(!to || !amount){ err("Укажите получателя и количество."); return; }

      log(`Попытка отправить ${amount} Amcoin на ${to} (demo flow).`);
      // TODO: Реализовать отправку через TonWeb + Wallet contract.
      // Ниже демонстрация шагов в псевдокоде:
      /*
        1) Создать экземпляр JettonMaster(root)
        2) Отправителю: ownerWallet = await JettonMaster.getWalletAddress(senderAddress)
        3) Получатель: recipientWallet = await JettonMaster.getWalletAddress(to)
        4) Сформировать payload для transfer: (amount, recipient_wallet, forward_amount, response_destination, custom_payload)
        5) Вызвать token transfer методом на sender's jetton-wallet с подписью через Wallet contract (или через multisig)
        6) Подпись производится через walletContract.createTransfer и подписывается ed25519 ключом.
      */
      log("Внимание: автоматическая отправка пока не реализована в шаблоне. Я пометил места, где нужно дописать код с TonWeb и подписанием транзакции.");
      document.getElementById('txResult').textContent = "Функция отправки не завершена в шаблоне — требуется доработка (см. логи).";
    });

    // ---------- Дополнительные замечания/рекомендации ----------
    /*
      - LICENSE: если вы клонируете код из mytonwallet-org/mytonwallet под GPL-3.0, вы обязаны сохранить лицензию и указать авторов при распространении.
      - Для production:
         * Используйте secure enclave / hardware wallet или WebAuthn для хранения ключей.
         * Не храните seed в localStorage в незашифрованном виде.
         * Проходите аудит смарт-контрактов и фронтенда (особенно части, работающей с seed).
         * Заботьтесь о CORS и о репутации RPC (не храните секреты в RPC-контрактах).
      - Чтобы полноценно реализовать функционал TIP-3 (jetton), рекомендуемые шаги:
         1) Изучить TonWeb token.jetton API (или другой SDK, актуальный на момент разработки).
         2) Реализовать методы: getWalletAddress(root, owner), call get_balance на jetton-wallet, формирование payload transfer.
         3) Формирование и подпись внешних internal-транзакций (через wallet contract).
    */

    log("Шаблон загружен. Замените placeholders и допишите логику отправки / взаимодействия с токеном Amcoin.");
  </script>
</body>
</html>
